<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zhudalao243.github.io","root":"/","images":"/images","scheme":"Mist","version":"8.7.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"b2t":false,"scrollpercent":true},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜尋...","empty":"我們無法找到任何有關 ${query} 的搜索結果","hits_time":"${hits} 找到 ${time} 個結果","hits":"找到 ${hits} 個結果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta property="og:type" content="website">
<meta property="og:title" content="上善若水">
<meta property="og:url" content="http://zhudalao243.github.io/index.html">
<meta property="og:site_name" content="上善若水">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="zzy">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://zhudalao243.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-TW","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>上善若水</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="上善若水" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">上善若水</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">成为一个有智慧的人</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>標籤</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分類</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>關於</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="zzy"
      src="/images/header.jpg">
  <p class="site-author-name" itemprop="name">zzy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">41</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="回到頂端">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://zhudalao243.github.io/2023/05/04/%E6%98%93%E7%BB%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="zzy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/05/04/%E6%98%93%E7%BB%8F/" class="post-title-link" itemprop="url">易经</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>
      

      <time title="創建時間：2023-05-04 17:44:31 / 修改時間：17:45:51" itemprop="dateCreated datePublished" datetime="2023-05-04T17:44:31+08:00">2023-05-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%93%B2%E5%AD%A6/" itemprop="url" rel="index"><span itemprop="name">哲学</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="上經"><a href="#上經" class="headerlink" title="上經"></a>上經</h2><h3 id="一-乾為天-䷀"><a href="#一-乾為天-䷀" class="headerlink" title="一. 乾為天 ䷀"></a>一. 乾為天 ䷀</h3><p>​        乾，元亨利貞。初九：潛龍，勿用。九二：見龍在田，利見大人。九三：君子終日乾乾，夕惕若，厲，無咎。九四：或躍在淵，無咎。九五：飛龍在天，利見大人。上九：亢龍，有悔。用九：見群龍無首，吉。</p>
<p>​        《彖》曰：大哉乾元！萬物資始，乃統天。雲行雨施，品物流形。大明始終，六位時成，時乘六龍以御天。乾道變化，各正性命。保合大和，乃利貞，首出庶物，萬國咸寧。</p>
<p>​        《象》曰：天行健，君子以自強不息。“潛龍勿用”，陽在下也。“見龍在田”，德施普也。“終日乾乾”，反復道也。“或躍在淵”，進無咎也。“飛龍在天”，大人造也。“亢龍有悔”，盈不可久也。“用九”，天德不可為首也。</p>
<p>​        《文言》曰：“元”者，善之長也；“亨”者，嘉之會也；“利”者，義之和也；“貞”者，事之幹也。君子體仁足以長人，嘉會足以合禮，利物足以合義，貞固足以幹事。君子行此四德者，故曰“乾：元亨利貞”。</p>
<p>​        初九曰“潛龍勿用”，何謂也？子曰：“龍，德爾隱者也。不易乎世，不成乎名，遯世無悶，不見是而無悶，樂則行之，憂則違之，確乎其不可拔，‘潛龍’也。”<br>        九二曰“見龍在田，利見大人”，何謂也？子曰：“龍，德爾中正者也。庸言之信，庸行之謹，閒(xi&aacute;n)邪存其誠，善世而不伐，德博而化。《易》曰‘見龍在田，利見大人’，君德也。”<br>        九三曰“君子終日乾乾，夕惕若，厲，無咎”，何謂也？子曰：“君子進德修業。忠信，所以進德也；修辭立其誠，所以居業也。知至至之，可與言幾也；知終終之，可與存義也。是故，居上位而不驕，在下位而不憂。故乾乾因其時而惕，雖危無咎矣。”&lt;br/ &gt;        九四曰“或躍在淵，無咎”，何謂也？子曰：“上下無常，非為邪也；進退無恆，非離群也。君子進德修業，欲及時也，故無咎。”<br>        九五曰“飛龍在天，利見大人”，何謂也？子曰：“同聲相應，同氣相求。水流濕，火就燥；雲從龍，風從虎。聖人作而萬物睹。本乎天者親上，本乎地者親下，則各從其類也。”<br>        上九曰“亢龍有悔”，何謂也？子曰：“貴而無位，高而無民。贤人在下，位而無輔。是以動而有悔也。”</p>
<p>​        “潛龍勿用”，下也。“見龍在田”，時捨也。“終日乾乾”，行事也。“或躍在淵”，自試也。“飛龍在天”，上治也。“亢龍有悔”，窮之災也。乾元“用九”，天下治也。<br>        “潛龍勿用”，陽氣潛藏。“見龍在田”，天下文明。“終日乾乾”，與時偕(xi&eacute;)行。“或躍在淵”，乾道乃革。“飛龍在天”，乃位乎天德。“亢龍有悔”，與時偕極。乾元“用九”，乃見天則。<br>        《乾》“元”者，始而亨者也。“利貞”者，性情也。乾始，能以美利利天下，不言所利，大矣哉。大哉乾乎！剛健中正，純粹精也。六爻發揮，旁通情也。時乘“六龍”，以御天也。“雲行雨施”，天下平也。</p>
<p>​        君子以成德為行，日可見之行也。“潛”之為言也，隱而未見，行而未成，是以君子弗用也。<br>        君子學以聚之，問以辨之，寬以居之，仁以行之。《易》曰“見龍在田，利見大人”，君德也。<br>        九叁重剛而不中，上不在天，下不在田，故乾乾因其時而惕，雖危無咎矣。<br>        九四重剛而不中，上不在天，下不在田，中不在人，故“或”之。或之者，疑之也，故無咎。<br>        夫大人者，與天地合其德，與日月合其明，與四時合其序，與鬼神和其吉凶。先天而天弗違，後天而奉天時，天且弗違，而況於人乎！況於鬼神乎！<br>        “亢”之為言也，知進而不知退，知存而不知亡，知得而不知喪。其惟聖人乎？知進退存亡而不失其正者，其惟聖人乎！</p>
<h3 id="二-坤为地-䷁"><a href="#二-坤为地-䷁" class="headerlink" title="二. 坤为地 ䷁"></a>二. 坤为地 ䷁</h3><p>​        坤，元亨，利牝馬之貞。君子有攸往，先迷後得主。利西南得朋，東北喪朋。安貞吉。<br>        初六：履霜，堅冰至。<br>        六二：直方，大，不習，無不利。<br>        六三：含章可貞。或從王事，無成有終。<br>        六四：括囊，無咎無譽。<br>        六五：黃裳，元吉。<br>        上六：龍戰於野，其血玄黃。<br>        用六：利永貞。</p>
<p>​        《彖》曰：至哉坤元，萬物滋生，乃順承天。坤厚載物，德合無疆。含弘光大，品物咸寧。牝馬地類，行地無疆，柔順利貞。君子攸行，先迷失道，後順得常。西南得朋，乃與類行；東北喪朋，乃終有慶。安貞之吉，應地無疆。</p>
<p>​        《象》曰：地勢坤，君子以厚德載物。“履霜堅冰”，陰始凝也，馴致其道，至堅冰也。六二之動，直以方也。“不習無不利”，地道光也。“含章可貞”，以時發也。“或從王事”，知光大也。“括囊無咎”，慎不害也。“黃裳元吉”，文在中也。“龍戰於野”，其道窮也。用六“永貞”，以大終也。</p>
<p>​        《文言》曰：坤至柔而動也剛，至靜而德方，後得主而有常，含萬物而化光。坤道其順乎！承天而時行。<br>        積善之家，必有餘慶；積不善之家，必有餘殃。臣弒其君，子弒其父，非一朝一夕之故，其所由來者漸矣，由辨之不早辨也。<br>        《易》曰：“履霜，堅冰至”，蓋言順也。<br>        直，其正也；方，其義也。君子敬以直內，義以方外，敬義立而德不孤。“直方，大，不習，無不利”，則不疑其所行也。<br>        陰雖有美，含之以從王事，弗敢成也。地道也，妻道也，臣道也。地道無成，而代有終也。<br>        天地變化，草木蕃。天地閉，賢人隱。《易》曰：“擴囊，無咎無譽”，蓋言謹也。<br>        君子黃中通理，正位居體。美在其中，而暢於四支，發於事業，美之至也！<br>        陰疑於陽必“戰”，為其嫌于無陽也，故稱“龍”焉。猶未離其類也，故曰“血”焉。夫“玄黃”者，天地之雜也，天玄而地黃。</p>
<h3 id="三-水雷屯-䷂"><a href="#三-水雷屯-䷂" class="headerlink" title="三.  水雷屯 ䷂"></a>三.  水雷屯 ䷂</h3><p>​        屯，元亨，利貞。勿用有攸往，利建侯。<br>        初九：盤桓(huan)。利居貞，利建侯。<br>        六二：屯如邅(zhan)如，乘馬班如。匪寇婚媾(gou)。女子貞不字，十年乃字。<br>        六三：即鹿無虞，惟入於林中。君子幾，不如捨。往吝。<br>        六四：乘馬班如，求婚媾。往吉，無不利。<br>        九五：屯其膏。小貞吉，大貞兇。<br>        上六：乘馬班如，泣血漣如。</p>
<p>​        《彖》曰：屯，剛柔始交而難生。動乎險中，大亨貞。雷雨之動滿盈，天造草昧，宜建侯而不寧。<br>        《象》曰：雲雷，屯。君子以經綸。雖“盤桓”，志行正也。以貴下賤，大得民也。六二之難，乘剛也。“十年乃字”，反常也。“即鹿無虞”，以從禽也。君子捨之，往吝窮也。求而往，明也。“屯其膏”，施未光也。“泣血漣如”，何可長也。</p>
<h3 id="四-山水蒙-䷃"><a href="#四-山水蒙-䷃" class="headerlink" title="四. 山水蒙 ䷃"></a>四. 山水蒙 ䷃</h3><p>​        蒙，亨。匪我求童蒙，童蒙求我。初筮(shi)告，再三瀆，凟則不告。利貞。<br>        初六：發蒙。利用刑人，用說桎梏。以往吝。<br>        九二：包蒙，吉。納婦吉，子克家。<br>        六三：勿用取女，見金夫不有躬。無攸利。<br>        六四：困蒙，吝。<br>        六五：童蒙，吉。<br>        上九：擊蒙。不利為寇，利御寇。</p>
<p>​        《彖》曰：蒙，山下有險。險而止，蒙。蒙“亨”，以亨行時中也。“匪我求童蒙，童蒙求我”，志應也。“初筮告”，以剛中也。“再三瀆，凟則不告”，凟蒙也。蒙以養正，聖功也。<br>        《象》曰：山下出泉，蒙。君子以果行育德。“利用刑人”，以正法也。“子克家”，剛柔接也。“勿用取女”，行不順也。“困蒙”之“吝”，獨遠實也。“童蒙”之吉，順以巽也。“利用御寇”，上下順也。</p>
<h3 id="五-水天需-䷄"><a href="#五-水天需-䷄" class="headerlink" title="五. 水天需 ䷄"></a>五. 水天需 ䷄</h3><p>​        需，有孚，光亨，貞吉。利涉大川。<br>        初九：需於郊，利用恆，無咎。<br>        九二：需於沙，小有言，終吉。<br>        九三：需於泥，致寇至。<br>        六四：需於血，出自穴。<br>        九五：需於酒食，貞吉。<br>        上六：入於穴，有不速之客三人來，敬之終吉。</p>
<p>​        《彖》曰：需，須也。險在前也，剛健而不陷，其義不困窮矣。“需，有孚，光亨，貞吉”，位乎天位，以中正也。“利涉大川”，往有功也。<br>        《象》曰：雲上於天，需。君子以飲食宴樂。“需與郊”，不犯難行也。“利用恆，無咎”，未失常也。“需於沙”，衍在中也。雖“小有言”，以終吉也。“需於泥”，災在外也。自我“致寇”，敬慎不敗也。“需與血”，順以聽也。“酒食，貞吉”，以中正也。“不速之客”來，“敬之終吉”。雖不當位，未大失也。</p>
<h3 id="六-天水訟-䷅"><a href="#六-天水訟-䷅" class="headerlink" title="六. 天水訟 ䷅"></a>六. 天水訟 ䷅</h3><p>​        訟，有孚窒惕，中吉，終凶。利見大人，不利涉大川。<br>        初六：不永所事，小有言，終吉。<br>        九二：不克訟，歸而逋。其邑人叁百戶，無眚(sheng)。<br>        六三：食舊德，貞厲，終吉。或從王事，無成。<br>        九四：不克訟，複即命，渝安貞，吉。<br>        九五：訟，元吉。<br>        上九：或錫之鞶(pan)帶，終朝叁褫(chi)之。</p>
<p>​        《彖》曰：訟，上剛下險。險而健，訟。“訟，有孚窒惕，中吉”，剛來而得中也。“終凶”，訟不可成也。“利見大人”，尚中正也。“不利涉大川”，入於淵也。<br>        《象》曰：天與水違行，訟。君子以作事謀始。“不永所事”，訟不可長也。雖“小有言”，其辯明也。“不克訟”，歸逋竄(cuan)也。自下訟上，患至掇(duo)也。“食舊德”，從上吉也。“復即命渝”，安真不失也。“訟，元吉”，以中正也。以訟受服，亦不足敬也。</p>
<h3 id="七-地水師-䷆"><a href="#七-地水師-䷆" class="headerlink" title="七. 地水師 ䷆"></a>七. 地水師 ䷆</h3><p>​        師，貞，丈人吉。無咎。<br>        初六：師出以律，否臧(zang)凶。<br>        九二：在師中，吉，無咎。王叁錫命。<br>        六三：師或輿尸，凶。<br>        六四：師左次，無咎。<br>        六五：田有禽，利執言，無咎。長子帥師，弟子與尸。貞凶。<br>        上六：大君有命，開國承家，小人勿用。</p>
<p>​        《彖》曰：師，眾也。貞，正也。能以眾正，可以王矣。剛中而應，行險而順，以此毒天下，而民從之，吉，又何咎矣！<br>        《象》曰：地中有水，師。君子以容民畜眾。“師出以律”，失律兇也。“在師中，吉”，承天寵也。“王叁錫命”，懷萬邦也。“師或輿尸”，大無功也。“左次，無咎”，未失常也。“長子帥師”，以中行也。“弟子與尸”，使不當也。“大君有命”，以正功也。“小人勿用”，必亂邦也。</p>
<h3 id="八-水地比-䷇"><a href="#八-水地比-䷇" class="headerlink" title="八. 水地比 ䷇"></a>八. 水地比 ䷇</h3><p>​        比，吉。原筮，元永貞，無咎。不寧方來，後夫兇。<br>        初六：有孚，比之，無咎。有孚盈缶，終來有它，吉。<br>        六二：比之自內，貞吉。<br>        六三：比之匪人。<br>        六四：外比之，貞吉。<br>        九五：顯比。王用叁驅失前禽。邑人不誡，吉。<br>        上六：比之無首，凶。</p>
<p>​        《彖》曰：比，吉也。比，輔也，下順從也。“原筮，元永貞，無咎”，以剛中也。“不寧方來”，上下應也。“後夫兇”，其道窮也。<br>        《象》曰：地上有水，比。先王以建萬國，親諸侯。比之初六，有它吉也。“比之自內”，不自失也。“比之匪人”，不亦傷乎！外比於賢，以從上也。“顯比”之吉，位正中也。捨逆取順，“失前禽也”。“邑人不誡”，上使中也。“比之無首”，無所終也。</p>
<h3 id="九-風天小蓄-䷈"><a href="#九-風天小蓄-䷈" class="headerlink" title="九. 風天小蓄 ䷈"></a>九. 風天小蓄 ䷈</h3><p>​        小蓄，亨。密雲不雨，自我西郊。<br>        初九：複自道，何其咎？吉。<br>        九二：牽復，吉。        <br>        九三：輿說輹，夫妻反目。<br>        六四：有孚，血去惕出，無咎。<br>        九五：有孚攣如，富以其鄰。<br>        上九：既雨既處，尚德載，婦貞厲，月幾望，君子征兇。</p>
<p>​        《彖》曰：小畜，柔得位而上下應之，曰小畜。健而巽，剛中而志行，乃亨。“密雲不雨”，尚往也。“自我西郊”，施未行也。<br>        《象》曰：風行天上，小畜。君子以懿文德。“複自道”，其義吉也。“牽複”在中，亦不自失也。“夫妻反目”，不能正室也。“有孚惕出”，上合志也。“有孚攣如”，不獨富也。“既雨既處”，德積載也。“君子征兇”，有所疑也。</p>
<h3 id="十-天澤履-䷉"><a href="#十-天澤履-䷉" class="headerlink" title="十. 天澤履 ䷉"></a>十. 天澤履 ䷉</h3><p>​        履：履虎尾，不咥人。亨。<br>        初九：素履往，無咎。<br>        九二：履道坦坦，幽人貞吉。<br>        六三：眇能視，跛能履。履虎尾，咥人，凶。武人為於大君。<br>        九四：履虎尾，愬愬終吉。<br>        九五：夬履，貞厲。<br>        上九：視履考祥，其旋元吉。</p>
<p>​        《彖》曰：履，柔履剛也。說而應乎乾，是以“履虎尾，不咥人，亨”。剛中正，履帝位而不疚，光明也。<br>        《象》曰：上天下澤，履。君子以辯上下，定民志。“素履”之往，獨行願也。“幽人貞吉”，中不自亂也。“眇能視”，不足以有明也。“跛能履”，不足以與行也。“咥人”之兇，位不當也。“武人為於大君”，志剛也。“愬愬終吉”，志行也。“夬履，貞厲”，為正當也。“元吉”在上，大有慶也。</p>
<h3 id="十一-地天泰-䷊"><a href="#十一-地天泰-䷊" class="headerlink" title="十一. 地天泰 ䷊"></a>十一. 地天泰 ䷊</h3><p>​        泰，小往大來，吉， 亨。<br>        初九：拔茅茹，以其匯，征吉。<br>        九二：包荒，用馮河，不暇遺，朋亡。得尚于中行。<br>        九三：無平不陂，無往不復。堅貞無咎。勿恤其孚，於食有福。<br>        六四：翩翩，不富以其鄰，不戒以孚。<br>        六五：帝乙歸妹，以祉，元吉。<br>        上六：城複于隍，勿用師，自邑告命。貞吝。</p>
<p>​        《彖》曰：“泰，小往大來，吉，亨”，則是天地交而萬物通也，上下交而其志同也。內陽而外陰，內健而外順。內君子而外小人，君子道長，小人道消也。<br>        《象》曰：天地交，泰。後以財成天地之道，輔相天地之宜，以左右民。“拔茅”“征吉”，志在外也。“包荒”“得尚於中行”，以光大也。“無往不復”，天地際也。“翩翩不富”，皆失實也。“不戒以孚”，中心願也。“以祉元吉”，中以行願也。“城複於隍”，其命亂也。</p>
<h3 id="十二-天地否-䷋"><a href="#十二-天地否-䷋" class="headerlink" title="十二. 天地否 ䷋"></a>十二. 天地否 ䷋</h3><p>​        否，否之匪人，不利君子貞。大往小來。<br>        初六：拔茅茹，以其匯。貞吉亨。<br>        六二：包承。小人吉，大人否亨。<br>        六三：包羞。<br>        九四：有命無咎，籌離祉。<br>        九五：休否，大人吉。其亡其亡，繫於包桑。<br>        上九：傾否，先否後喜。</p>
<p>​        《彖》曰：“否之匪人，不利君子貞。大往小來”，則是天地不交，而萬物不通也。上下不交，而天下無邦也。內陰而外陽，內柔而外剛，內小人而外君子。小人道長，君子道消也。<br>        《象》曰：天地不交，否。君子以儉德闢難，不可榮以祿。“拔茅”“貞吉”，志在君也。“大人否亨”，不亂群也。“包羞”，位不當也，“有命無咎”，志行也。“大人”之吉，位正當也。否終則傾，何可長也？</p>
<h3 id="十三-天火同人-䷌"><a href="#十三-天火同人-䷌" class="headerlink" title="十三. 天火同人 ䷌"></a>十三. 天火同人 ䷌</h3><p>​        同人，同人於野，亨，利涉大川。利君子貞。<br>        初九：同人於門，無咎。<br>        六二：同人於宗，吝。<br>        九三：伏戎於莽。升其高陵，叁歲不興。<br>        九四：乘其墉，弗克攻，吉。<br>        九五：同人先號啕而後笑。大師克相遇。<br>        上九：同人於郊，無悔。        </p>
<p>​        《彖》曰：同人，柔得位得中而應乎乾，曰同人。同人曰：“同人於野，亨，利涉大川”，乾行也。文明以健，中正而應，君子正也。唯君子為能通天下之至。<br>        《象》曰：天與火，同人。君子以類族辨物。出門“同人”，又誰咎也？“同人於宗”，吝道也。“伏戎於莽”，敵剛也。“叁歲不興”，安行也。“乘其墉”，義弗克也；其“吉”，則困而反則也。同人之“先”，以中直也。“大師”相遇，言相剋也。“同人於郊”，志未得也。</p>
<p>​        </p>
<h2 id="下经"><a href="#下经" class="headerlink" title="下经"></a>下经</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://zhudalao243.github.io/2023/04/13/%E4%B8%AD%E5%BA%B8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="zzy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/13/%E4%B8%AD%E5%BA%B8/" class="post-title-link" itemprop="url">中庸</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>
      

      <time title="創建時間：2023-04-13 10:24:55 / 修改時間：10:26:14" itemprop="dateCreated datePublished" datetime="2023-04-13T10:24:55+08:00">2023-04-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%93%B2%E5%AD%A6/" itemprop="url" rel="index"><span itemprop="name">哲学</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="第一章"><a href="#第一章" class="headerlink" title="第一章"></a>第一章</h3><p>​        天命之谓性，率性之谓道，修道之谓教。<br>​        道也者，不可须臾(yu)离也，可离非道也。是故君子戒慎乎其所不睹，恐惧乎其所不闻。莫见乎隐，莫显乎微。故君子慎其独也。喜怒哀乐之未发，谓之中；发而皆中节，谓之和。中也者，天下之大本也；和也者，天下之达道也。致中和，天地位焉，万物育焉。    </p>
<h3 id="第二章"><a href="#第二章" class="headerlink" title="第二章"></a>第二章</h3><p>​        仲尼曰：“君子中庸，小人反中庸。君子之中庸也，君子而时中；小人之中庸也，小人而无忌惮也。”</p>
<h3 id="第三章"><a href="#第三章" class="headerlink" title="第三章"></a>第三章</h3><p>​        子曰：“中庸其至矣乎！民鲜能久矣！”</p>
<h3 id="第四章"><a href="#第四章" class="headerlink" title="第四章"></a>第四章</h3><p>​        子曰：“道之不行也，我知之矣；知者过之，愚者不及也，我知之矣；贤者过之，不肖者不及也。人莫不饮食也，鲜能知味也。”</p>
<h3 id="第五章"><a href="#第五章" class="headerlink" title="第五章"></a>第五章</h3><p>​        子曰：“道其不行矣夫。”</p>
<h3 id="第六章"><a href="#第六章" class="headerlink" title="第六章"></a>第六章</h3><p>​        子曰：“舜其大知也与！舜好问而好察迩(er)言，隐恶而扬善，执其两端，用其中于民。其斯以为舜乎！”</p>
<h3 id="第七章"><a href="#第七章" class="headerlink" title="第七章"></a>第七章</h3><p>​        子曰：“人皆曰予(yu)知。驅(qu)而納諸罟(gu)擭(huo)陷阱之中，而莫之知辟(bi)也。人皆曰予知，擇乎中庸而不能期月守也。”</p>
<h3 id="第八章"><a href="#第八章" class="headerlink" title="第八章"></a>第八章</h3><p>​        子曰：“回之為人也，擇乎中庸，得一善，則拳拳服膺(ying)而弗失之矣。”</p>
<h3 id="第九章"><a href="#第九章" class="headerlink" title="第九章"></a>第九章</h3><p>​        子曰：“天下國家可均也，爵祿可辭也，白刃可蹈(dao)也，中庸不可能也。”</p>
<h3 id="第十章"><a href="#第十章" class="headerlink" title="第十章"></a>第十章</h3><p>​        子路問強。子曰：“南方之強與？北方之強與？抑而強與？寬柔以教，不報無道，南方之強也，君子居之。祍(ren)金革,死而不厌，北方之強也，而強者居之。故君子和而不流，強哉矯！中立而不倚，強哉矯！國有道，不變塞(se)焉，強哉矯！國無道，至死不變，強哉矯！”</p>
<h3 id="第十一章"><a href="#第十一章" class="headerlink" title="第十一章"></a>第十一章</h3><p>​        子曰：“素隱行怪，後世有述焉，吾弗為之矣。君子遵道而行，半途而廢，吾弗能已(yi)矣。君子依乎中庸，遯世不見知而不悔，唯聖者能之。”</p>
<h3 id="第十二章"><a href="#第十二章" class="headerlink" title="第十二章"></a>第十二章</h3><p>​        君子之道費而隱。夫婦之愚，可以與知焉，及其至也，雖聖人亦有所不知焉。夫婦之不肖，可以能行焉，及其至也，雖聖人亦有所不能焉。天地之大也，人猶有所憾。故君子語大，天下莫能載焉；語小，天下莫能破焉。《詩》云：“鳶(yuan)飛戾(li)天，魚躍(yue)於淵。”言其上下察也。君子之道，造端乎父母，及其至也，察乎天地。</p>
<h3 id="第十三章"><a href="#第十三章" class="headerlink" title="第十三章"></a>第十三章</h3><p>​        子曰：“道不遠人。人之為道而遠人，不可以為道。《詩》云：‘伐柯伐柯，其則不遠。’執柯以伐柯，睨而視之，猶以為遠。故君子以人治人。改而止。忠恕違道不遠，施諸己而不願，亦勿(wu)施于人。君子之道四，丘未能一焉：所求乎子以事父，未能也；所求乎臣以事君，未能也；所求乎弟以事兄，未能也；所求乎朋友先施之，未能也。庸德之行，庸言之謹。有所不足，不敢不勉，有餘不敢盡。言顧行，行顧言，君子胡不慥慥(zao)爾(er)？”</p>
<h3 id="第十四章"><a href="#第十四章" class="headerlink" title="第十四章"></a>第十四章</h3><p>​        君子素其位而行，不願乎其外。<br>​        素富貴，行乎富貴；素貧賤，行乎貧賤；素夷狄，行乎夷狄；素患難，行乎患難。君子無入而不自得焉。<br>​        在上位，不陵下；在下位，不援上。正己而不求於人，則無怨。上不怨天，下不尤人。<br>​        故君子居易以俟命，小人行險以僥倖。子曰：“射有似乎君子，失諸正鵠(gu)，反求諸其身。”</p>
<h3 id="第十五章"><a href="#第十五章" class="headerlink" title="第十五章"></a>第十五章</h3><p>​        君子之道，闢(bi)如行遠必自邇，闢如登高必自卑。《詩》曰：“妻子好合，如鼓瑟(se)琴(qin)。兄弟既翕(xi)，和樂且耽(dan)。宜爾室家，樂爾妻帑(nu)。”子曰：“父母其順矣乎！”</p>
<h3 id="第十六章"><a href="#第十六章" class="headerlink" title="第十六章"></a>第十六章</h3><p>​        子曰：“鬼神之為德，其盛矣乎！視之而弗見，聽之而弗聞，體物而不可遺。使天下之人，齋(zhai)明盛服，以承祭祀。洋洋乎！如在其上，如在其左右。《詩》曰：‘神之格思，不可度(duó)思，矧(shěn)可射(yì)思。’夫微之顯，誠之不可掩如此夫！”</p>
<h3 id="第十七章"><a href="#第十七章" class="headerlink" title="第十七章"></a>第十七章</h3><p>​        子曰：“舜其大孝也與！德為聖人，尊為天子，富有四海之內，宗廟饗之，子孫保之。故大德必得其位，必得其祿，必得其名，必得其壽。故天之生物，必因其材而篤焉。故栽者培之，傾者覆之。《詩》曰：‘嘉樂君子，顯顯令德。宜民宜人，受祿於天。保佑命之，自天申之。’故大德者必受命。”    </p>
<h3 id="第十八章"><a href="#第十八章" class="headerlink" title="第十八章"></a>第十八章</h3><p>​        子曰：“無憂者其惟文王乎！以王季為父，以武王為子。父作之，子述之。武王纘(zuan)太王、王季、文王之緒，壹戎衣而有天下。身不失天下之顯名，尊為天子，富有四海之內，宗廟饗之，子孫保之。武王末(mo)受命，周公成文、武之德，追王太王、王季，上祀先王以天子之禮。斯禮也，達乎諸侯大夫，及士庶人。父為大夫，子為士，葬以大夫，祭以士。父為士，子為大夫，葬以士，祭以大夫。期之喪，達乎大夫。三年之喪，達乎天子。父母之喪，無貴賤一也。”</p>
<h3 id="第十九章"><a href="#第十九章" class="headerlink" title="第十九章"></a>第十九章</h3><p>​        子曰：“武王、周工其達孝矣乎！夫孝者，善繼人之志，善述人之事者也。春秋修其祖廟，陳其宗器，設其裳衣，薦其時食。宗廟之禮，所以序昭穆也；序爵，所以辨貴賤也；序事，所以辨賢也；旅酬下為上，所以逮賤也；燕毛，所以序齿也。踐其位，行其禮，奏其樂，敬其所尊，愛其所親，事死如事生，事亡如事存，孝之至也。郊社之禮，所以事上帝也。宗廟之禮，所以祀乎其先也。明乎郊社之禮、禘(di)嘗之義，治國其如示諸掌乎。”    </p>
<h3 id="第二十章"><a href="#第二十章" class="headerlink" title="第二十章"></a>第二十章</h3><p>​        哀公問政。子曰：“文武之政，佈在方策。其人存，則其政舉；其人亡，則其政息。人道敏政，地道敏樹。夫政也者，蒲盧也。故為政在人，取人以身，修身以道，修道以仁。仁者，人也，親親為大。義者，宜也，尊賢為大。親親之殺，尊賢之等，禮所生也。故君子不可以不修身。思修身，不可以不事親；思事親，不可以不知人；思知人，不可以不知天。”<br>​        天下之達道五，所以行之者三。曰君臣也，父子也，夫妇也，昆弟也，朋友之交也；五者，天下之达道也。智、仁、勇三者，天下之达德也，所以行之者一也。或生而知之，或学而知之，或困而知之，及其知之一也。或安而行之，或利而行之，或勉强而行之，及其成功一也。子曰：“好学近乎知，力行近乎仁，知耻近乎勇。知斯三者，则知所以修身；知所以修身，则知所以治人；知所以治人，则知所以治天下国家矣。”<br>​        凡為天下國家有九經。曰：修身也，尊賢也，親親也，敬大臣也，體群臣也，子庶民也，來百工也，柔遠人也，懷諸侯也。修身則道立，尊賢則不惑，親親則諸父昆弟不怨，敬大臣則不眩，體群臣則士之報禮重，子庶民則百姓勸，來百工則財用足，柔遠人則四方歸之，懷諸侯則天下畏之。<br>​        齋明盛服，非禮不動，所以修身也。去讒遠色，賤貨而貴德，所以勸賢也。尊其位，重其錄，同其好惡，所以勸親親也。官盛任使，所以勸大臣也。忠信重祿，所以勸士也。時使薄斂，所以勸百姓也。日省月試，既稟稱(chen)事，所以勸百工也。送往迎來，嘉善而矜不能，所以柔遠人也。繼絕世，舉廢國，治亂持危，朝(chao)聘以時，厚往而薄來，所以懷諸侯也。凡為天下國家有九經，所以行之者一也。<br>​        凡事預則立，不預則廢。言前定則不跲(jia)，事前定則不困，行前定則不疚，道前定則不窮。<br>​        在下位不獲乎上，民不可得而治矣。獲乎上有道：不信乎朋友，不獲乎上矣。信乎朋友有道：不順乎親，不信乎朋友矣。順乎親有道：反諸身不誠，不順乎親矣。誠身有道：不明乎善，不誠乎身矣。<br>​        誠者，天之道也；誠之者，人之道也。誠者，不勉而中，不思而得，从容中道，圣人也。诚之者，择善而固执之者也。博學之，審問之，慎思之，明辨之，篤行之。有弗學，學之弗能弗措也；有弗問，問之弗知弗措也；有弗思，思之弗得弗措也；有弗辨，辨之弗明弗措也；有弗行，行之弗篤弗措也。人一能之，己百之；人十能之，己千之。果能此道矣，雖愚必明，雖柔必強。    </p>
<h3 id="第二十一章"><a href="#第二十一章" class="headerlink" title="第二十一章"></a>第二十一章</h3><p>​        自誠明，謂之性；自明誠，謂之教。誠則明矣，明則誠矣。</p>
<h3 id="第二十二章"><a href="#第二十二章" class="headerlink" title="第二十二章"></a>第二十二章</h3><p>​        唯天下至誠，為能盡其性；能盡其性，則能盡人之性；能盡人之性，則能盡物之性；能盡物之性，則可以讚天地之化育；可以讚天地之化育，則可以與天地參(can)矣。</p>
<h3 id="第二十三章"><a href="#第二十三章" class="headerlink" title="第二十三章"></a>第二十三章</h3><p>​        其次致曲，曲能有誠。誠則形，形則著，著則明，明則動，動則變，變則化。唯天下至誠為能化。</p>
<h3 id="第二十四章"><a href="#第二十四章" class="headerlink" title="第二十四章"></a>第二十四章</h3><p>​        至誠之道，可以前知。國家將興，必有禎祥；國家將亡，必有妖孽。見(xian)乎蓍(shi)龜(gui)，動乎四體。禍福將至：善，必先知之；不善，必先知之。故至誠如神。</p>
<h3 id="第二十五章"><a href="#第二十五章" class="headerlink" title="第二十五章"></a>第二十五章</h3><p>​        誠者自成也，而道自道也。誠者物之終始，不誠無物。是故君子誠之為貴。誠者，非自成己而己也，所以成物也。成己，仁也；成物，知也。性之德也，合外內之道也，故時措之宜也。</p>
<h3 id="第二十六章"><a href="#第二十六章" class="headerlink" title="第二十六章"></a>第二十六章</h3><p>​        故至誠無息，不息則久，久則征，征則悠遠，悠遠則博厚，博厚則高明。博厚，所以載物也；高明，所以覆物也；悠久，所以成物也。博厚配地，高明配天，悠久無疆。如此者，不見而章，不動而變，無為而成。<br>​        天地之道，可一言而盡也；其為物不貳，則其生物不測。天地之道：博也，厚也，高也，明也，悠也，久也。今夫天，斯昭昭之多，及其無窮也，日月星辰係焉，萬物覆焉。今夫地，一撮土之多，及其廣厚，載華岳而不重，振河海而不瀉，萬物載焉。今夫山，一卷石之多，及其廣大，草木生之，禽獸居之，寶藏興焉。今夫水，一勺之多，及其不測，鼋(yuan)、鼍(tuo)、蛟、龙、鱼、鳖生焉，貨財殖焉。<br>​        《詩》云：“維天之命，於穆不已！”蓋曰天之所以為天也。“於乎不顯，文王之德之純！”蓋曰文王之所以為文也，純亦不已。</p>
<h3 id="第二十七章"><a href="#第二十七章" class="headerlink" title="第二十七章"></a>第二十七章</h3><p>​    大哉聖人之道！洋洋乎！發育萬物，駿極於天。優優大哉！禮儀三百，威儀三千。待其人而後行。故曰苟不至德，至道不凝焉。故君子尊德性而道問學，致廣大而盡精微，極高明而道中庸。溫故而知新，敦厚以崇禮。是故居上不驕，為下不倍。國有道其言足以興，國無道其默足以容。《詩》曰：“既明且哲，以保其身。”其此之謂與？</p>
<h3 id="第二十八章"><a href="#第二十八章" class="headerlink" title="第二十八章"></a>第二十八章</h3><p>​        子曰：“愚而好自用，賤而好自專，生乎今之世，反古之道。如此者，災及其身者也。”<br>​        非天子，不議禮，不制度，不考文。今天下車同軌，書同文，行同倫。雖有其位，苟無其德,不敢作禮樂焉；雖有其德，苟無其位，亦不敢作禮樂焉。<br>​        子曰：“吾說夏禮，杞不足徵也；吾學殷禮，有宋存焉；吾學周禮，今用之，吾從周。”</p>
<h3 id="第二十九章"><a href="#第二十九章" class="headerlink" title="第二十九章"></a>第二十九章</h3><p>​        王天下有三重焉，其寡過矣乎！上焉者，雖善無征，無征不信，不信民弗從。下焉者，雖善不尊，不尊不信，不信民弗從。<br>​        故君子之道，本諸身，徵諸庶民，考諸三王而不繆，建諸天地而不悖，質諸鬼神而無疑，百世以俟聖人而不惑。質諸鬼神而無疑，知天也；百世以俟聖人而不惑，知人也。是故君子動而世天下道，行而世為天下法，言而世為天下則。遠之則有望，近之則不厭。<br>​        《詩》曰：“在彼無惡，在此無射。庶幾夙夜，以永終譽(yu)。”君子未有不如此而有譽於天下者。</p>
<h3 id="第三十章"><a href="#第三十章" class="headerlink" title="第三十章"></a>第三十章</h3><p>​        仲尼祖述堯、舜，憲章文、武，上律天時，下襲水土。闢如天地之無不持載，無不覆幬(dao)，闢如四時之錯行，如日月之代明。萬物並育而不相害，道並行而不相悖。小德川流，大德敦化。此天地之所以為大也！</p>
<h3 id="第三十一章"><a href="#第三十一章" class="headerlink" title="第三十一章"></a>第三十一章</h3><p>​        唯天下至聖，為能聰明睿智，足以有臨也；寬裕溫柔，足以有容也；發強剛毅，足以有執也；齊(qi)莊中正，足以有敬也；文理密察，足以有別也；溥博淵泉，而時出之。溥博如天，淵泉如淵。見而民莫不敬，言而民莫不信，行而民莫不說。是以聲名洋溢乎中國，施及蠻(man)貊(m&ograve;)。舟車所至，人力所通，天之所覆，地之所載，日月所照，霜露所隊，凡有血氣者，莫不尊親。故曰配天。    </p>
<h3 id="第三十二章"><a href="#第三十二章" class="headerlink" title="第三十二章"></a>第三十二章</h3><p>​        唯天下至誠，為能經綸天下之大經，立天下之大本，知天地之化育。夫焉有所倚？肫肫(zh&umacr;n)其仁，淵淵其淵，浩浩其天。苟不固聰明聖知達天德者，其孰能知之。</p>
<h3 id="第三十三章"><a href="#第三十三章" class="headerlink" title="第三十三章"></a>第三十三章</h3><p>​        《詩》曰：“衣(y&igrave;)錦尚絅(jiong)。”惡(wu)其文之著(zhu)也。故君子之道，闇(an)然而日章；小人之道，的(di)然而日亡。君子之道，淡而不厌，简而文，温而理，知远之近，知风之自，知微之显，可於入德矣。</p>
<p>​        《詩》曰：“潛雖伏矣，亦孔之昭！“故君子內省不疚，無惡(wu)於志。君子之所不可及者，其唯人之所不見乎？</p>
<p>​        《詩》曰：“相在爾室，尚不愧於屋漏。”故君子不動而敬，不言而信。</p>
<p>​        《詩》曰：“奏假無言，時靡有爭。”是故君子不賞而民勸，不怒而民威於鈇(f&umacr;)鉞(yu&egrave;)。</p>
<p>​        《詩》曰：“不顯維德，百辟(bi)其刑之。”是故君子篤恭而天下平。</p>
<p>​        《詩》曰：“予懷明德，不大聲以色。”子曰：“声色之于以化民，末也。”</p>
<p>​        《詩》曰：“德輶(you)如毛。”毛猶有倫，“上天之載，無聲無臭（xiu）。”至矣！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://zhudalao243.github.io/2022/05/18/%E7%B4%AB%E8%96%87%E5%91%BD%E7%9B%98%E5%AE%9E%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="zzy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/18/%E7%B4%AB%E8%96%87%E5%91%BD%E7%9B%98%E5%AE%9E%E4%BE%8B/" class="post-title-link" itemprop="url">紫薇命盘实例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>
      

      <time title="創建時間：2022-05-18 09:09:34 / 修改時間：10:51:06" itemprop="dateCreated datePublished" datetime="2022-05-18T09:09:34+08:00">2022-05-18</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>算命时间：2022年5月18日    算命人：家良父亲</p>
<img src="/2022/05/18/%E7%B4%AB%E8%96%87%E5%91%BD%E7%9B%98%E5%AE%9E%E4%BE%8B/1652836320140.png" width="70%">

<p>家良老爸（后用此人代指）：此人天马禄存入命宫，这是奔波劳累做生意发财的命，此人命宫三方四正还会到太阴太阳，太阳落陷，太阴旺，此人母亲以及太太会对其有很大帮助。12-21岁此十年为父母宫擎羊落陷，这十年无大运，同时结合太阳星落陷，此人父亲有灾，会在父亲身上花费很多精力以及钱财。22-31岁进入福德宫化忌在此宫，这十年会要比12-21岁好些，但仍然是诸事不顺。并且福德宫对宫財帛宮巨门星落陷，在22-31这十年，会受到小人口舌是非上的影响，还会有打官司的可能。32-41这十年在田宅宫武曲破军化权，这十年事业会有起色，但是仍然不会挣太多钱，另外在这十年此人有可能会对传统文化或者宗教产生兴趣。42-51岁这十年没什么好说的，一般。52-61岁，62-71岁，72-81岁此人连续三十年大运，很旺，发财。52-81这三十年，总体好的，但是要有警戒之心，在54、55、61、66、67在几个流年不是很好尤其是54和66，没有什么大凶放心。虽说52-81有三十年大运，但是主要是前20年，72-81这十年发财就算了吧，年纪太大了。</p>
<p>身体方面：酉宫、戌宫这两个宫比较凶，此二宫代表的身体部位为：左胸、左肋、肾、心。留意一下就好，这个不是很准。</p>
<p>算命时间：2022年5月18日    算命人：家良母亲</p>
<img src="/2022/05/18/%E7%B4%AB%E8%96%87%E5%91%BD%E7%9B%98%E5%AE%9E%E4%BE%8B/1652839782399.png" width="70%">

<p>家良老妈（后用此人代指）：太阴太阳入命宫，且太阳落陷太阴很旺。太阴入命且旺，此人年轻时候一定很漂亮，性格也是很温柔的。但是命宫还有太阳落陷，此人性格总体而言应该是：平常待人很温柔的，但是遇到事情有时也会很暴躁。此人命宫化科，身宫在官祿宮，凭借专业技术在公家单位吃饭。 14-23岁，父母宫贪狼文昌落陷且化忌，此人父母处于生离的状态，跟随母亲生活，跟妈妈比较亲（你给我说过，属于马后炮），14-23这十年的运不是很好，但是文昌星在此宫，推测这十年学习应该挺好，但是考试不中。24-33，34-43此为人生中最旺的二十年，事事遂心。另外此人福德宫很好，福德宫主人一生的福气，也代表女人的婚姻，同时夫妻宫也很好，因此此人婚姻美满很顺。44-53这十年大运也挺好的，没什么大问题；54-63这十年就一般了，但是也没什么大问题。结合实际情况，你老妈就在家歇着就行了，看看佛经、给你介绍个对象啊或者给你爸爸出谋划策什么的。</p>
<p>同时结合你老爸，52-71这20年很运势旺，且太阴星很亮。对于男人来说阴代表母亲和太太，个人推测应该是：你妈在后面出谋划策，你爸在外做事情，你爸能发笔财。</p>
<p>身体状况：未宫、酉宫比较差，这两个宫对应的身体部位为：左胸、小肠、肾和头。留意一下就好，这个不是很准。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://zhudalao243.github.io/2022/05/16/%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B001/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="zzy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/16/%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B001/" class="post-title-link" itemprop="url">阅读笔记01</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2022-05-16 13:53:25" itemprop="dateCreated datePublished" datetime="2022-05-16T13:53:25+08:00">2022-05-16</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新於</span>
        <time title="修改時間：2022-05-17 09:44:20" itemprop="dateModified" datetime="2022-05-17T09:44:20+08:00">2022-05-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%93%B2%E5%AD%A6/" itemprop="url" rel="index"><span itemprop="name">哲学</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%93%B2%E5%AD%A6/%E7%B4%AB%E5%BE%AE%E6%96%97%E6%95%B0%E7%B2%BE%E6%88%90%EF%BC%88%E5%A4%A7%E5%BE%B7%E5%B1%B1%E4%BA%BA%E7%BC%96%E8%91%97%EF%BC%89/" itemprop="url" rel="index"><span itemprop="name">紫微斗数精成（大德山人编著）</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>​        易學中的同性相生，即陽生陽、陰生陰，生力大；異性相生，即陽生陰、陰生陽，生力小。陰陽同性相剋，即陰剋陰、陽剋陽，剋性大，是真剋，無情之剋；陰陽異性相剋，即陰剋陽、陽剋陰，剋性不大，是有情之剋，衹是適度的管制約束而已。</p>
<p>​        旺相休囚死。當令者旺，令生者相，生令者囚，令剋者死，（令是指四季，春季木當令，夏季火當令，秋季金當令，冬季水當令，三、六、九、十二月土當令）。十二長生順序：長生、沐浴、冠帶、臨官、帝旺、衰、病、死、墓、絕、胎、養。金長生在巳，木長生在亥，火長生在寅，水土長生在申。在鬥數中，長生、冠帶、臨官、帝旺屬於旺相；衰、病、死、墓、絕屬於衰相；沐浴屬於破敗；胎、養屬於中間溫養狀態。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://zhudalao243.github.io/2021/12/09/Go%E5%8D%8F%E7%A8%8B%E6%B3%84%E9%9C%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="zzy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/12/09/Go%E5%8D%8F%E7%A8%8B%E6%B3%84%E9%9C%B2/" class="post-title-link" itemprop="url">Go协程泄露</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>
      

      <time title="創建時間：2021-12-09 10:20:32 / 修改時間：10:58:52" itemprop="dateCreated datePublished" datetime="2021-12-09T10:20:32+08:00">2021-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="GO协程泄露和修复"><a href="#GO协程泄露和修复" class="headerlink" title="GO协程泄露和修复"></a>GO协程泄露和修复</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wujilei5/article/details/93512768">原文链接</a></p>
<p>golang中goroutine使用原则：<font color="red">在不知道如何停止的情况下，永远不要启动goroutine。</font></p>
<p>泄漏goroutines的情况非常常见，下面举例说明：</p>
<p>构建一个自定义map结构体，map的键配置配置成在持续时间后过期。代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> expiringValue <span class="keyword">struct</span> &#123;</span><br><span class="line">	expiration time.Time</span><br><span class="line">	data       []<span class="keyword">byte</span> <span class="comment">// the actual value</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Map <span class="keyword">struct</span> &#123;</span><br><span class="line">	data <span class="keyword">map</span>[<span class="keyword">string</span>]expiringValue   </span><br><span class="line">	expiration time.Duration   <span class="comment">// map中的键持续时间</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span> <span class="title">removeExpired</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 循环便利 m.data 中的数据，对于每一个expiringValue，对现在的时间进行对比，查看是否超过expiration，判断是否删除。</span></span><br><span class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> m.data&#123;</span><br><span class="line">		now := time.Now()</span><br><span class="line">		<span class="keyword">if</span> now.Sub(v.expiration) &gt; m.expiration&#123;</span><br><span class="line">			<span class="built_in">delete</span>(m.data, k)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span> <span class="title">Set</span><span class="params">(key <span class="keyword">string</span>, val []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line">	data := expiringValue&#123;</span><br><span class="line">		data: val,</span><br><span class="line">		expiration: time.Now(),</span><br><span class="line">	&#125;</span><br><span class="line">	m.data[key] = data</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m Map)</span> <span class="title">Get</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="params">([]<span class="keyword">byte</span>, <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> e, ok := m.data[key]; !ok&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> e.data, <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 为了确保键到期能被删除，我们在NewMap函数中启动一个工作协程：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMap</span><span class="params">(expiration time.Duration)</span> *<span class="title">Map</span></span> &#123;</span><br><span class="line">	m := &amp;Map&#123;</span><br><span class="line">		data:       <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]expiringValue),</span><br><span class="line">		expiration: expiration,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// start a worker goroutine</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> <span class="keyword">range</span> time.Tick(expiration) &#123;</span><br><span class="line">			m.removeExpired()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">return</span> m</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>工作协程将根据配置时间，周期性的调用map类型的方法以删除任何过期的键。因此在调用SetKey时需要记录键添加的时间，这就是数据字段包含expiringValue类型的原因，该类型将实际值与到期时间相关联.</p>
<p>乍一看，工作协程的调用似乎很好。如果这不是一个关于协程泄漏的帖子，这段代码也许不会有什么问题。但实际上，我们在构造函数中泄漏了一个协程。是怎么泄漏的呢？</p>
<p>让我们来看看Map的典型生命周期。首先，调用者创建Map的实例。创建实例后，一个工作协程开始运行。接下来，调用者可以对Set和Get进行任意数量的调用。但最终，调用者将完成使用Map实例并释放对它的所有引用。此时，垃圾收集器通常能够收集实例的内存。但是，删除过期key的工作仍在运行，并且还保留了Map实例的引用。由于没有明确的调用来停止工作协程，我们泄漏了一个协程，并泄漏了Map实例的内存。</p>
<p>我们使用运行时包来查看有关内存分配器的统计信息以及在特定时刻运行的Go协程的数量。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> stats runtime.MemStats</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            runtime.ReadMemStats(&amp;stats)</span><br><span class="line">            fmt.Printf(<span class="string">&quot;HeapAlloc    = %d\n&quot;</span>, stats.HeapAlloc)</span><br><span class="line">            fmt.Printf(<span class="string">&quot;NumGoroutine = %d\n&quot;</span>, runtime.NumGoroutine())</span><br><span class="line">            time.Sleep(<span class="number">5</span>*time.Second)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        work()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">work</span><span class="params">()</span></span> &#123;</span><br><span class="line">    m := NewMap(<span class="number">5</span>*time.Minute)</span><br><span class="line">    m.Set(<span class="string">&quot;my-key&quot;</span>, []<span class="keyword">byte</span>(<span class="string">&quot;my-value&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> _, ok := m.Get(<span class="string">&quot;my-key&quot;</span>); !ok &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;no value present&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// m goes out of scope</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很快就可以看到堆分配和Go协程的数量增长很多。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HeapAlloc    = <span class="number">76960</span></span><br><span class="line">NumGoroutine = <span class="number">18</span></span><br><span class="line">HeapAlloc    = <span class="number">2014278208</span></span><br><span class="line">NumGoroutine = <span class="number">1447847</span></span><br><span class="line">HeapAlloc    = <span class="number">3932578560</span></span><br><span class="line">NumGoroutine = <span class="number">2832416</span></span><br><span class="line">HeapAlloc    = <span class="number">5926163224</span></span><br><span class="line">NumGoroutine = <span class="number">432252</span></span><br></pre></td></tr></table></figure>

<p>所以现在很明显我们需要停止那个Go协程。目前，Map API没有办法关闭工作协程。最好避免修改任何API，并在调用者使用完Map实例时能停止工作协程。但只有调用者知道什么时候该停止。</p>
<p>解决此问题的常见模式是实现io.Closer接口。当调用者使用完Map时，他们可以调用Close来告诉Map停止其工作协程。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Map <span class="keyword">struct</span> &#123;</span><br><span class="line">	data <span class="keyword">map</span>[<span class="keyword">string</span>]expiringValue</span><br><span class="line">	expiration time.Duration</span><br><span class="line">	done <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMap</span><span class="params">(expiration time.Duration)</span> *<span class="title">Map</span></span> &#123;</span><br><span class="line">    m := &amp;Map&#123;</span><br><span class="line">        data:       <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]expiringValue),</span><br><span class="line">        expiration: expiration,</span><br><span class="line">        done:       <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// start a worker goroutine</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        ticker := time.NewTicker(expiration)</span><br><span class="line">        <span class="keyword">defer</span> ticker.Stop()</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            <span class="keyword">select</span> &#123;</span><br><span class="line">                <span class="keyword">case</span> &lt;-ticker.C:</span><br><span class="line">                    m.removeExpired()</span><br><span class="line">                <span class="keyword">case</span> &lt;-m.done:</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">var</span> stats runtime.MemStats</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			runtime.ReadMemStats(&amp;stats)</span><br><span class="line">			fmt.Printf(<span class="string">&quot;HeapAlloc    = %d\n&quot;</span>, stats.HeapAlloc)</span><br><span class="line">			fmt.Printf(<span class="string">&quot;NumGoroutine = %d\n&quot;</span>, runtime.NumGoroutine())</span><br><span class="line">			time.Sleep(<span class="number">5</span>*time.Second)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		work()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">work</span><span class="params">()</span></span> &#123;</span><br><span class="line">	m := NewMap(<span class="number">5</span>*time.Minute)</span><br><span class="line">	m.Set(<span class="string">&quot;my-key&quot;</span>, []<span class="keyword">byte</span>(<span class="string">&quot;my-value&quot;</span>))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> _, ok := m.Get(<span class="string">&quot;my-key&quot;</span>); !ok &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;no value present&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	m.done &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">	<span class="comment">// m goes out of scope</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果如下</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HeapAlloc    = <span class="number">72464</span></span><br><span class="line">NumGoroutine = <span class="number">6</span></span><br><span class="line">HeapAlloc    = <span class="number">5175200</span></span><br><span class="line">NumGoroutine = <span class="number">59</span></span><br><span class="line">HeapAlloc    = <span class="number">5495008</span></span><br><span class="line">NumGoroutine = <span class="number">35</span></span><br><span class="line">HeapAlloc    = <span class="number">9171136</span></span><br><span class="line">NumGoroutine = <span class="number">240</span></span><br><span class="line">HeapAlloc    = <span class="number">8347120</span></span><br><span class="line">NumGoroutine = <span class="number">53</span></span><br></pre></td></tr></table></figure>

<p>数字很小，这是因为调用工作协程的循环比较小。但更重要的是，Go协程或堆分配数量没有再大幅增长了。这正是我们想要的结果。</p>
<p>这篇文章展示了一个明显的例子，说明为什么知道何时停止Go协程如此重要。另一方面，也可以说监控应用程序中的Go协程数量一样很重要。如果Go协程泄漏潜入代码库，这样的监控程序可以提供一个警告系统。还值得记住的是，有时Go协程泄漏需要数天甚至数周才能在应用程序中显示，所以拥有更短和更长时间跨度的监视程序很有必要。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://zhudalao243.github.io/2021/11/20/goNote01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="zzy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/20/goNote01/" class="post-title-link" itemprop="url">goNote01</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2021-11-20 10:09:44" itemprop="dateCreated datePublished" datetime="2021-11-20T10:09:44+08:00">2021-11-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新於</span>
        <time title="修改時間：2021-11-24 15:20:56" itemprop="dateModified" datetime="2021-11-24T15:20:56+08:00">2021-11-24</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="gofmt-格式化命令"><a href="#gofmt-格式化命令" class="headerlink" title="gofmt 格式化命令"></a>gofmt 格式化命令</h3><img src="/2021/11/20/goNote01/image-20211120101130947.png" alt="image-20211120101130947" style="zoom:80%;">

<h3 id="Golang-环境变量配置及其作用"><a href="#Golang-环境变量配置及其作用" class="headerlink" title="Golang 环境变量配置及其作用"></a>Golang 环境变量配置及其作用</h3><p>GOROOT: 指定 go sdk 安装目录。<br>Path: 指令 sdk\bin 目录：go.exe godoc.exe gofmt.exe<br>GOPATH: 就是 golang 工作目录：我们的所有项目的源码都这个目录下。</p>
<img src="/2021/11/20/goNote01/image-20211120211125271.png" alt="image-20211120211125271" style="zoom:80%;">

<p>go语言总值类型包括：基本数据类型 int 系列, float 系列, bool, string 、数组和 结构体 struct</p>
<p>引用类型：指针、slice 切片、map、管道 chan、interface 等都是引用类型</p>
<h3 id="值类型和引用类型的使用特点"><a href="#值类型和引用类型的使用特点" class="headerlink" title="值类型和引用类型的使用特点"></a>值类型和引用类型的使用特点</h3><ol>
<li>值类型：变量直接存储值，内存通常在栈中分配<br>示意图：</li>
</ol>
<img src="/2021/11/20/goNote01/image-20211120225507401.png" alt="image-20211120225507401" style="zoom:80%;">

<ol start="2">
<li>引用类型：变量存储的是一个地址，这个地址对应的空间才真正存储数据(值)，内存通常在堆<br>上分配，当没有任何变量引用这个地址时，该地址对应的数据空间就成为一个垃圾，由 GC 来回收</li>
</ol>
<img src="/2021/11/20/goNote01/image-20211120225539343.png" alt="image-20211120225539343" style="zoom:80%;">

<p>如果变量名、函数名、常量名首字母大写，则可以被其他的包访问；如果首字母小写，则只能<br>在本包中使用 ( 注：可以简单的理解成， 首字母大写是公开的， 首字母小写是私有的) ,在 golang 没 有<br>public , private 等关键字。</p>
<p>Type Switch：switch 语句还可以被用于 type-switch 来判断某个 interface 变量中实际指向的<br>变量类型</p>
<img src="/2021/11/20/goNote01/image-20211121124942312.png" alt="image-20211121124942312" style="zoom:80%;">

<p>如果我们的字符串含有中文，那么传统的遍历字符串方式，就是错误，会出现乱码。原因是传统的<br>对字符串的遍历是按照 字节来遍历，而一个汉字在 utf8 编码是对应 3 个字节。</p>
<p>如何解决 需要要将 str 转成 []rune 切片.=&gt; 体验一把</p>
<img src="/2021/11/20/goNote01/image-20211121131133556.png" alt="image-20211121131133556" style="zoom:80%;">

<p>对应 for-range 遍历方式而言，是按照字符方式遍历。因此如果有字符串有中文，也是 ok</p>
<img src="/2021/11/20/goNote01/image-20211121131146498.png" alt="image-20211121131146498" style="zoom:80%;">

<h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><img src="/2021/11/20/goNote01/image-20211121212757065.png" alt="image-20211121212757065" style="zoom:80%;">

<h3 id="自定义错误"><a href="#自定义错误" class="headerlink" title="自定义错误"></a>自定义错误</h3><p>Go 程序中，也支持自定义错误， 使用 errors.New 和 panic 内置函数。</p>
<ol>
<li>errors.New(“错误说明”) , 会返回一个 error 类型的值，表示一个错误</li>
<li>panic 内置函数 ,接收一个 interface{}类型的值（也就是任何值了）作为参数。可以接收 error 类<br>型的变量， 输出错误信息，</li>
</ol>
<img src="/2021/11/20/goNote01/image-20211121213410011.png" alt="image-20211121213410011" style="zoom:80%;">

<p>如果使用 netstat –an 可以查看本机有哪些端口在监听</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://zhudalao243.github.io/2021/11/06/c-%E6%B3%A8%E6%84%8F%E7%82%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="zzy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/06/c-%E6%B3%A8%E6%84%8F%E7%82%B9/" class="post-title-link" itemprop="url">c++注意点</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2021-11-06 19:42:26" itemprop="dateCreated datePublished" datetime="2021-11-06T19:42:26+08:00">2021-11-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新於</span>
        <time title="修改時間：2021-11-07 09:19:40" itemprop="dateModified" datetime="2021-11-07T09:19:40+08:00">2021-11-07</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ol>
<li>不可以在函数内部返回局部变量的引用。</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回局部变量引用</span></span><br><span class="line"><span class="function"><span class="keyword">int</span>&amp; <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> a = <span class="number">10</span>; <span class="comment">//局部变量</span></span><br><span class="line">	<span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//返回静态变量引用</span></span><br><span class="line"><span class="function"><span class="keyword">int</span>&amp; <span class="title">test02</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">int</span> a = <span class="number">20</span>;</span><br><span class="line">	<span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//不能返回局部变量的引用</span></span><br><span class="line">	<span class="keyword">int</span>&amp; ref = <span class="built_in">test01</span>();</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;ref = &quot;</span> &lt;&lt; ref &lt;&lt; endl;  <span class="comment">// ref = 10</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;ref = &quot;</span> &lt;&lt; ref &lt;&lt; endl;  <span class="comment">// ref = 1479064544  此处会出现错误，避免该错误不要返回局部变量的引用。  因为局部变量保存在栈区，函数结束，内存也就释放了</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//如果函数做左值，那么必须返回引用</span></span><br><span class="line">    <span class="comment">// 局部静态变量保存在全局区，不会随着函数结束而内存释放，所以不会出现上述问题。</span></span><br><span class="line">	<span class="keyword">int</span>&amp; ref2 = <span class="built_in">test02</span>();  </span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;ref2 = &quot;</span> &lt;&lt; ref2 &lt;&lt; endl;   </span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;ref2 = &quot;</span> &lt;&lt; ref2 &lt;&lt; endl;</span><br><span class="line">	<span class="built_in">test02</span>() = <span class="number">1000</span>;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;ref2 = &quot;</span> &lt;&lt; ref2 &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;ref2 = &quot;</span> &lt;&lt; ref2 &lt;&lt; endl;</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>c++继承方式</li>
</ol>
<img src="/2021/11/06/c-%E6%B3%A8%E6%84%8F%E7%82%B9/image-20211107091913409.png" alt="image-20211107091913409 " style="zoom:50%;"> 




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://zhudalao243.github.io/2021/11/06/%E5%A4%A7%E5%AD%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="zzy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/06/%E5%A4%A7%E5%AD%A6/" class="post-title-link" itemprop="url">大学</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>
      

      <time title="創建時間：2021-11-06 13:28:48 / 修改時間：13:59:26" itemprop="dateCreated datePublished" datetime="2021-11-06T13:28:48+08:00">2021-11-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%93%B2%E5%AD%A6/" itemprop="url" rel="index"><span itemprop="name">哲学</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%93%B2%E5%AD%A6/%E5%A4%A7%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">大學</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="大學"><a href="#大學" class="headerlink" title="大學"></a>大學</h1><h2 id="大學經綸章：初學入德之門"><a href="#大學經綸章：初學入德之門" class="headerlink" title="大學經綸章：初學入德之門"></a>大學經綸章：初學入德之門</h2><p>​       大學之道，在明明德，在親民，在止於至善。知止而後有定，定而後能靜，靜而後能安，安而後能慮，慮而後能得。物有本末，事有終始，知有先後，則近道矣。古之欲明明德於天下者，先治其國。欲治其國者，先齊其家。欲齊其家者，先修其身。欲修其身者，先正其心。欲正其心者，先誠其意。欲誠其意者，先致其知。致知在格物。格物而後知至。知至而後意誠。意誠而後心正。心正而後身修。身修而後家齊。家齊而後國治。國治而後天下平。自天子以至於庶人，壹是皆以修身為本。其本亂，而未治者，否矣。其所厚者薄，而其所薄者厚，未之有也。此謂知本，此謂知之至也。</p>
<h2 id="康诰盘铭、邦畿章：将美好得品德发扬光大"><a href="#康诰盘铭、邦畿章：将美好得品德发扬光大" class="headerlink" title="康诰盘铭、邦畿章：将美好得品德发扬光大"></a>康诰盘铭、邦畿章：将美好得品德发扬光大</h2><p>​       </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://zhudalao243.github.io/2021/10/13/%E6%9D%8E%E7%99%BD%E7%9A%84%E4%B8%AD%E5%9B%BD%E8%AF%97%E6%AD%8C%E5%8F%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="zzy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/13/%E6%9D%8E%E7%99%BD%E7%9A%84%E4%B8%AD%E5%9B%BD%E8%AF%97%E6%AD%8C%E5%8F%B2/" class="post-title-link" itemprop="url">李白的中国诗歌史</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>
      

      <time title="創建時間：2021-10-13 08:56:16 / 修改時間：09:31:38" itemprop="dateCreated datePublished" datetime="2021-10-13T08:56:16+08:00">2021-10-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%93%B2%E5%AD%A6/" itemprop="url" rel="index"><span itemprop="name">哲学</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%93%B2%E5%AD%A6/%E5%94%90%E8%AF%97%E6%96%B0%E6%80%9D%E8%B7%AF/" itemprop="url" rel="index"><span itemprop="name">唐诗新思路</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <div align="center"><font face="楷体">《古风》</font></div><div align="center"><font face="楷体">大雅久不作，吾衰竟谁陈。</font></div><font face="楷体">    <center>王风委蔓草，战国多荆榛。</center><center>龙虎相啖食，兵戈逮狂秦。</center><center>正声何微茫，哀怨起骚人。</center><center>扬马激颓波，开流荡无垠。</center><center>废兴虽万变，宪章亦已沦。</center><center>自从建安来，绮丽不足珍。</center><center>圣代复元古，垂衣贵清真。</center><center>群才属休明，乘运共跃鳞。</center><center>文质相炳焕，衆星罗秋旻。</center><center>我志在删述，垂辉映千春。</center><center>希圣如有立，绝笔于获麟。</center></font>




















      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://zhudalao243.github.io/2021/09/15/%E5%AF%B9sync-Map%E7%9A%84%E7%90%86%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="zzy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/09/15/%E5%AF%B9sync-Map%E7%9A%84%E7%90%86%E8%A7%A3/" class="post-title-link" itemprop="url">对sync.Map的理解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>
      

      <time title="創建時間：2021-09-15 08:21:42 / 修改時間：09:58:46" itemprop="dateCreated datePublished" datetime="2021-09-15T08:21:42+08:00">2021-09-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="并发报错的map"><a href="#并发报错的map" class="headerlink" title="并发报错的map"></a>并发报错的map</h2><p>举例：一个goroutine一直读，一个goroutine一只写同一个键值，即即使读写的键不相同，而且map也没有”扩容”等操作，代码还是会报错。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			_ = m[<span class="number">1</span>]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			m[<span class="number">2</span>] = <span class="number">2</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">select</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>错误信息是： <font color="red"><code>fatal error: concurrent map read and map write</code></font></p>
<p>源码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line"> 	 ...</span><br><span class="line">	hashWriting  = <span class="number">4</span> <span class="comment">// a goroutine is writing to the map</span></span><br><span class="line">	...</span><br><span class="line">) </span><br><span class="line"><span class="keyword">type</span> hmap <span class="keyword">struct</span> &#123;</span><br><span class="line">	...</span><br><span class="line">	flags     <span class="keyword">uint8</span></span><br><span class="line">	...</span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">// map是检查是否有另外线程修改h.flag来判断，是否有并发问题。</span></span><br><span class="line"><span class="comment">// 在更新map的函数里检查并发写</span></span><br><span class="line"><span class="keyword">if</span> h.flags&amp;hashWriting == <span class="number">0</span> &#123;</span><br><span class="line">	throw(<span class="string">&quot;concurrent map writes&quot;</span>)</span><br><span class="line">&#125;	</span><br><span class="line"><span class="comment">// 在读map的函数里检查是否有并发写</span></span><br><span class="line"><span class="keyword">if</span> h.flags&amp;hashWriting != <span class="number">0</span> &#123;</span><br><span class="line">	throw(<span class="string">&quot;concurrent map read and map write&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Go通过map结构体中的flags字段来管理并发。当程序试图修改map（赋新值、删除value或者清空map），flags字段的某一位会被设置为1：</p>
<p>hashWriting的值是4，并将相应的位设置为1。 ^是一个异或操作，如果两个操作数的位相反，则将对应位设置为1。</p>
<img src="/2021/09/15/%E5%AF%B9sync-Map%E7%9A%84%E7%90%86%E8%A7%A3/578e8ecd09367196eb5e37da0a608bb4.png" alt="img" style="zoom:67%;">

<p>然而，该标志位将在操作结束时被重置：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapdelete</span><span class="params">(t *maptype, h *hmap, key unsafe.Pointer)</span></span> &#123;</span><br><span class="line">   [...]</span><br><span class="line">   <span class="comment">// if another process is currently writing, throw error</span></span><br><span class="line">   <span class="keyword">if</span> h.flags&amp;hashWriting != <span class="number">0</span> &#123;</span><br><span class="line">      throw(<span class="string">&quot;concurrent map writes&quot;</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   [...]</span><br><span class="line">   <span class="comment">// no one is writing, we can set now the flag</span></span><br><span class="line">   h.flags ^= hashWriting   <span class="comment">// 0 0 0 1 0 0</span></span><br><span class="line">   [...]</span><br><span class="line">   <span class="comment">// flag reset</span></span><br><span class="line">   h.flags &amp;^= hashWriting</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="sync-Map"><a href="#sync-Map" class="headerlink" title="sync.Map"></a>sync.Map</h2><p>底层结构：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 封装的线程安全的map</span></span><br><span class="line"><span class="keyword">type</span> Map <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// lock</span></span><br><span class="line">	mu Mutex</span><br><span class="line">	<span class="comment">// 实际是readOnly这个结构</span></span><br><span class="line">	<span class="comment">// 一个只读的数据结构，因为只读，所以不会有读写冲突。</span></span><br><span class="line">	<span class="comment">// readOnly包含了map的一部分数据，用于并发安全的访问。(冗余，内存换性能)</span></span><br><span class="line">	<span class="comment">// 访问这一部分不需要锁。</span></span><br><span class="line">	read atomic.Value <span class="comment">// readOnly 原子性</span></span><br><span class="line">	<span class="comment">// dirty数据包含当前的map包含的entries,它包含最新的entries(包括read中未删除的数据,虽有冗余，但是提升dirty字段为read的时候非常快，不用一个一个的复制，而是直接将这个数据结构作为read字段的一部分),有些数据还可能没有移动到read字段中。</span></span><br><span class="line">	<span class="comment">// 对于dirty的操作需要加锁，因为对它的操作可能会有读写竞争。</span></span><br><span class="line">	<span class="comment">// 当dirty为空的时候， 比如初始化或者刚提升完，下一次的写操作会复制read字段中未删除的数据到这个数据中。</span></span><br><span class="line">	dirty <span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]*entry</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 当从Map中读取entry的时候，如果read中不包含这个entry,会尝试从dirty中读取，这个时候会将misses加一，</span></span><br><span class="line">	<span class="comment">// 当misses累积到 dirty的长度的时候， 就会将dirty提升为read,避免从dirty中miss太多次。因为操作dirty需要加锁。</span></span><br><span class="line">	misses <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// readOnly is an immutable struct stored atomically in the Map.read field.</span></span><br><span class="line"><span class="keyword">type</span> readOnly <span class="keyword">struct</span> &#123;</span><br><span class="line">	m <span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]*entry</span><br><span class="line">	<span class="comment">// 如果Map.dirty有些数据不在m中，这个值为true</span></span><br><span class="line">	amended <span class="keyword">bool</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// An entry is a slot in the map corresponding to a particular key.</span></span><br><span class="line"><span class="keyword">type</span> entry <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// *interface&#123;&#125;</span></span><br><span class="line">	p unsafe.Pointer </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>readOnly中<code>amended</code>指明<code>Map.dirty</code>中有<code>readOnly.m</code>未包含的数据，所以如果从<code>Map.read</code>找不到数据的话，还要进一步到<code>Map.dirty</code>中查找。</p>
<p>这里虽然有冗余的两份map数据，但是Map.dirty和readOnly.m的value都是一个指针变量 *entry，所以整体内存占用还好。</p>
<p>sync.Map 的kv都是 interface{} ，entry里面的p实际是一个 *interface{}，也就是entry实际保存的是指向value的指针。</p>
<p>entry中的p有三个值：</p>
<ol>
<li>nil: entry已被删除了，并且m.dirty为nil</li>
<li>expunged: entry已被删除了，并且m.dirty不为nil，而且这个entry不存在于m.dirty中</li>
<li>其它： entry是一个正常的value</li>
</ol>
<h3 id="Load"><a href="#Load" class="headerlink" title="Load"></a>Load</h3><p>线程安全的加载key对应的value：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span> <span class="title">Load</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(value <span class="keyword">interface</span>&#123;&#125;, ok <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 1.首先从m.read中加载只读的readOnly, 从它的map中查找，无锁。</span></span><br><span class="line">	read, _ := m.read.Load().(readOnly)</span><br><span class="line">	e, ok := read.m[key]</span><br><span class="line">	<span class="comment">// 2. 如果没找到，并且m.dirty中有新数据，需要从m.dirty查找，这个时候需要加锁</span></span><br><span class="line">    <span class="comment">// read.amended 指明&#x27;Map.dirty`中有`readOnly.m`未包含的数据，所以如果从`Map.read`找不到数据的话，还要进一步到`Map.dirty`中查找</span></span><br><span class="line">	<span class="keyword">if</span> !ok &amp;&amp; read.amended &#123;</span><br><span class="line">		m.mu.Lock()</span><br><span class="line">		<span class="comment">// double check</span></span><br><span class="line">		read, _ = m.read.Load().(readOnly)</span><br><span class="line">		e, ok = read.m[key]</span><br><span class="line">		<span class="keyword">if</span> !ok &amp;&amp; read.amended &#123;</span><br><span class="line">			<span class="comment">// // 从m.dirty查找</span></span><br><span class="line">			e, ok = m.dirty[key]</span><br><span class="line">			<span class="comment">// 不管m.dirty中存不存在，都将misses计数加一</span></span><br><span class="line">			<span class="comment">// missLocked()中满足条件后就会提升m.dirty</span></span><br><span class="line">			m.missLocked()</span><br><span class="line">		&#125;</span><br><span class="line">		m.mu.Unlock()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 原子加载 *entry 所保存的value。</span></span><br><span class="line">	<span class="keyword">return</span> e.load()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span> <span class="title">missLocked</span><span class="params">()</span></span> &#123;</span><br><span class="line">	m.misses++</span><br><span class="line">	<span class="keyword">if</span> m.misses &lt; <span class="built_in">len</span>(m.dirty) &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	m.read.Store(readOnly&#123;m: m.dirty&#125;)</span><br><span class="line">	m.dirty = <span class="literal">nil</span></span><br><span class="line">	m.misses = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2021/09/15/%E5%AF%B9sync-Map%E7%9A%84%E7%90%86%E8%A7%A3/20200112110724714.png" alt="img" style="zoom:80%;">

<p>首先要强调的是，首先是从readonly里面读，读不到时候才加锁去 map.dirty 里面去读，并且加锁之后首先是进行double check(熟悉Java的都知道double check是什么)。</p>
<p>double check 之后即使不存在于m.read中，经过miss几次之后，m.dirty会被提升为m.read，又会从m.read中查找。所以对于更新／增加较少，加载存在的key很多的case,性能基本和无锁的map类似。</p>
<p>missLocked方法中可能会将m.dirty提升，m,misses会记录从readOnly中获取不到 *entry 的次数，也就是miss的次数，如果达到了 len(m.dirty) 就会原子的替换m.read.m 为 m.dirty。提升后m.dirty、m.misses重置， 并且m.read.amended为false。</p>
<h3 id="Store"><a href="#Store" class="headerlink" title="Store"></a>Store</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Store sets the value for a key.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span> <span class="title">Store</span><span class="params">(key, value <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 1. 如果m.read存在这个键，并且这个entry没有被标记删除(expunged)，尝试直接存储</span></span><br><span class="line">	<span class="comment">// 因为m.dirty也指向这个entry,所以m.dirty也保持最新的entry。</span></span><br><span class="line">	read, _ := m.read.Load().(readOnly)</span><br><span class="line">	<span class="keyword">if</span> e, ok := read.m[key]; ok &amp;&amp; e.tryStore(&amp;value) &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 2. m.read不存在或者已经被标记删除</span></span><br><span class="line">	m.mu.Lock()</span><br><span class="line">	<span class="comment">// double check</span></span><br><span class="line">	read, _ = m.read.Load().(readOnly)</span><br><span class="line">	<span class="keyword">if</span> e, ok := read.m[key]; ok &#123;</span><br><span class="line">		<span class="keyword">if</span> e.unexpungeLocked() &#123;<span class="comment">//标记成未被删除</span></span><br><span class="line">			<span class="comment">//m.dirty中不存在这个键，所以加入m.dirty</span></span><br><span class="line">			m.dirty[key] = e</span><br><span class="line">		&#125;</span><br><span class="line">		e.storeLocked(&amp;value)</span><br><span class="line">	<span class="comment">// m.dirty存在这个键，更新</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> e, ok := m.dirty[key]; ok &#123;</span><br><span class="line">		e.storeLocked(&amp;value)</span><br><span class="line">	<span class="comment">//新键值</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//m.dirty中没有比m.readOnly更新的数据，往m.dirty中增加第一个新键</span></span><br><span class="line">		<span class="keyword">if</span> !read.amended &#123;</span><br><span class="line">			<span class="comment">// 从m.read中复制未删除的数据</span></span><br><span class="line">			<span class="comment">// 并标记m.read已经落后于m.dirty</span></span><br><span class="line">			m.dirtyLocked()</span><br><span class="line">			m.read.Store(readOnly&#123;m: read.m, amended: <span class="literal">true</span>&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//将这个entry加入到m.dirty中</span></span><br><span class="line">		m.dirty[key] = newEntry(value)</span><br><span class="line">	&#125;</span><br><span class="line">	m.mu.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// tryStore stores a value if the entry has not been expunged.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If the entry is expunged, tryStore returns false and leaves the entry</span></span><br><span class="line"><span class="comment">// unchanged.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *entry)</span> <span class="title">tryStore</span><span class="params">(i *<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		p := atomic.LoadPointer(&amp;e.p)</span><br><span class="line">		<span class="keyword">if</span> p == expunged &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> atomic.CompareAndSwapPointer(&amp;e.p, p, unsafe.Pointer(i)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span> <span class="title">dirtyLocked</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> m.dirty != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	read, _ := m.read.Load().(readOnly)</span><br><span class="line">	m.dirty = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]*entry, <span class="built_in">len</span>(read.m))</span><br><span class="line">	<span class="keyword">for</span> k, e := <span class="keyword">range</span> read.m &#123;</span><br><span class="line">		<span class="keyword">if</span> !e.tryExpungeLocked() &#123;</span><br><span class="line">			m.dirty[k] = e</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2021/09/15/%E5%AF%B9sync-Map%E7%9A%84%E7%90%86%E8%A7%A3/20200112110342685.png" alt="img" style="zoom:40%;">

<p>以上操作都是先从操作m.read开始的，不满足条件再加锁，然后操作m.dirty。</p>
<p>可能会发生两种数据迁移：</p>
<ol>
<li><p>从m.dirty到m.read的迁移，这个迁移过程其实是指针的的修改，所以效率高；</p>
</li>
<li><p>从read map到dirty map的迁移, 这个迁移需要创建一个新的map来复制key-value，所以效率会低一些</p>
<p><font color="red">Store可能会在某种情况下（在刚初始化和将所有元素迁移到read中后，dirty默认都是nil元素，而此时如果有新的元素增加，则需要先将read map中的所有未删除数据先迁移到dirty中）从m.read中复制数据到m.dirty，如果这个时候m.read中数据量非常大，可能会影响性能。</font></p>
</li>
</ol>
<h3 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span> <span class="title">Delete</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 1. 如果不存在于 m.read中，而且 m.dirty 和 m.read 数据不一致。</span></span><br><span class="line">	read, _ := m.read.Load().(readOnly)</span><br><span class="line">	e, ok := read.m[key]</span><br><span class="line">	<span class="keyword">if</span> !ok &amp;&amp; read.amended &#123;</span><br><span class="line">		<span class="comment">// 加锁，double check， 然后删除对应的key。</span></span><br><span class="line">		m.mu.Lock()</span><br><span class="line">		read, _ = m.read.Load().(readOnly)</span><br><span class="line">		e, ok = read.m[key]</span><br><span class="line">		<span class="keyword">if</span> !ok &amp;&amp; read.amended &#123;</span><br><span class="line">			<span class="built_in">delete</span>(m.dirty, key)</span><br><span class="line">		&#125;</span><br><span class="line">		m.mu.Unlock()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ok &#123;</span><br><span class="line">		e.<span class="built_in">delete</span>()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2021/09/15/%E5%AF%B9sync-Map%E7%9A%84%E7%90%86%E8%A7%A3/20200112111125713.png" alt="img" style="zoom:80%;">

<p>这里会删除 m.dirty 对应的key-value, 但是m.read中的key-value其实并没有删除，只是设置了删除的标志为expunged。这里的惰性删除避免了重新创建 entry 实体，只用更新指针和value指针。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *entry)</span> <span class="title">delete</span><span class="params">()</span> <span class="params">(hadValue <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		p := atomic.LoadPointer(&amp;e.p)</span><br><span class="line">		<span class="keyword">if</span> p == <span class="literal">nil</span> || p == expunged &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> atomic.CompareAndSwapPointer(&amp;e.p, p, <span class="literal">nil</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Range"><a href="#Range" class="headerlink" title="Range"></a>Range</h3><p>这里sync.Map是对map关键字的封装，肯定无法使用系统提供的 for range 操作。所以这里采用了一个回调的操作：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span> <span class="title">Range</span><span class="params">(f <span class="keyword">func</span>(key, value <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span>)</span> &#123;</span><br><span class="line">	<span class="comment">// 如果m.dirty中有新数据，则提升m.dirty,然后在遍历</span></span><br><span class="line">	read, _ := m.read.Load().(readOnly)</span><br><span class="line">	<span class="keyword">if</span> read.amended &#123;</span><br><span class="line">		<span class="comment">///提升m.dirty</span></span><br><span class="line">		m.mu.Lock()</span><br><span class="line">		read, _ = m.read.Load().(readOnly)</span><br><span class="line">		<span class="keyword">if</span> read.amended &#123;</span><br><span class="line">			read = readOnly&#123;m: m.dirty&#125;</span><br><span class="line">			m.read.Store(read)</span><br><span class="line">			m.dirty = <span class="literal">nil</span></span><br><span class="line">			m.misses = <span class="number">0</span></span><br><span class="line">		&#125;</span><br><span class="line">		m.mu.Unlock()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 遍历, for range是安全的</span></span><br><span class="line">	<span class="keyword">for</span> k, e := <span class="keyword">range</span> read.m &#123;</span><br><span class="line">		v, ok := e.load()</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> !f(k, v) &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Range方法调用前可能会做一个m.dirty的提升，不过提升m.dirty不是一个耗时的操作。</p>
<h3 id="sync-Map总结"><a href="#sync-Map总结" class="headerlink" title="sync.Map总结"></a>sync.Map总结</h3><p>sync.Map的优化策略简单总结可以理解为：</p>
<ol>
<li>无锁读与读写分离；</li>
</ol>
<img src="/2021/09/15/%E5%AF%B9sync-Map%E7%9A%84%E7%90%86%E8%A7%A3/20200112110232202.png" alt="img" style="zoom:50%;">

<ol start="2">
<li>写加锁与延迟提升；</li>
</ol>
<img src="/2021/09/15/%E5%AF%B9sync-Map%E7%9A%84%E7%90%86%E8%A7%A3/20200112110214618.png" alt="img" style="zoom:50%;">

<ol start="3">
<li>指针与惰性删除，map保存的value都是指针。惰性删除，实际删除是在 Store时候去check 然后删除。</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zzy</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 強力驅動
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>




  





</body>
</html>
